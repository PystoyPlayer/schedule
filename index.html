<!DOCTYPE html>
<html lang="ru">
<head>
  <title>График</title>
  <meta charset="utf-8">
  <meta name="viewport" content="shrink-to-fit=no, width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <meta name="description" content="Расписание серий в Telegram канале @SubVost">
  <meta name="theme-color" content="#181818">
  <meta property="og:title" content="График выхода серий">
  <meta property="og:description" content="Расписание серий в Telegram канале @SubVost">
  <meta property="og:type" content="website">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/1.25.0/luxon.min.js"></script>
  <style>
    :root{
      /* базовые размеры (перекрываются режимами) */
      --fs-h1: 36px; --fs-h2: 24px; --fs-title:16px; --fs-time:16px; --fs-meta:13px; --fs-badge:12px;

      /* таймлайн */
      --gutter:20px; --rail-w:4px;
      --rail-c1:rgba(255,255,255,.16); --rail-c2:rgba(255,255,255,.28);

      /* маркер на таймлайне */
      --tag-h:26px; --tag-pad-x:8px; --tag-nudge:0px;
      --tag-bg:rgba(255,255,255,.10); --tag-br:rgba(255,255,255,.22); --tag-text:#ececec;
      --tag-shadow:0 8px 24px rgba(0,0,0,.35), 0 0 10px rgba(255,255,255,.12);

      /* таймкоды */
      --time-w-static: 90px;
      --time-bg: rgba(255,255,255,.12);
      --time-bg-hover: rgba(255,255,255,.18);
      --time-border: rgba(255,255,255,.10);
      --time-color: #e2e2e2;

      /* плейсхолдеры «Без графика» */
      --ph-bg: rgba(255,255,255,.09);
      --ph-border: rgba(255,255,255,.10);
      --ph-color:#bdbdbd;

      --row-hover: rgba(170,170,170,.10);
    }

    /* ===== ВИДЫ ===== */
    body.view-classic{ }

    body.view-compact{
      max-width:560px !important;
      --fs-h1: 34px; --fs-h2:22px; --fs-title:15px; --fs-time:15px; --fs-badge:12px; --fs-meta:12px;
      --gutter:18px; --rail-w:3px;
      --time-bg: rgba(255,255,255,.11);
      --time-bg-hover: rgba(255,255,255,.17);
      --time-border: rgba(255,255,255,.10);
      --row-hover: rgba(170,170,170,.08);
    }
    body.view-compact .schedule-item{ margin-bottom:4px; }
    body.view-compact h2{ margin:20px 0 4px; }

    body.view-minimal{
      --fs-h1: 34px; --fs-h2:20px; --fs-title:16px; --fs-time:16px; --fs-badge:12px;
      --gutter:18px; --rail-w:2px;
      --rail-c1: rgba(255,255,255,.10);
      --rail-c2: rgba(255,255,255,.16);
      --time-bg: transparent;
      --time-bg-hover: rgba(255,255,255,.06);
      --time-border: rgba(255,255,255,.16);
      --time-color:#dcdcdc;
      --row-hover: rgba(255,255,255,.035);
      --tag-bg: transparent; --tag-br: transparent; --tag-shadow:none;
    }
    /* Минимализм: только точка, без подписи/кольца/коннектора */
    @keyframes miniPulse{
      0%,100%{ box-shadow:0 0 0 2px rgba(255,255,255,.18), 0 0 8px rgba(255,255,255,.10) }
      50%    { box-shadow:0 0 0 3px rgba(255,255,255,.26), 0 0 14px rgba(255,255,255,.18) }
    }
    body.view-minimal #time-rail .now-tag .badge,
    body.view-minimal #time-rail .now-tag .ring,
    body.view-minimal #time-rail .now-tag .connector{ display:none !important; }
    body.view-minimal #time-rail .now-tag .dot{
      width:8px; height:8px; left:calc(var(--rail-w)/2 - 4px); top:-4px;
      background:#fff; border-radius:50%; animation: miniPulse 2.8s ease-in-out infinite;
    }
    body.view-minimal #schedule-wrap{ padding-left: calc(var(--gutter) + 8px) }
    body.view-minimal .schedule-item{ margin-bottom:4px; padding-left:12px; border-radius:6px; }
    body.view-minimal .time{
      background: var(--time-bg); border:1px solid var(--time-border);
      color: var(--time-color); border-radius:6px; padding:0 6px; box-shadow:none;
    }
    body.view-minimal .time.is-placeholder{ border-style:dashed; color:#a9a9a9; border-color:rgba(255,255,255,.12) }
    body.view-minimal h2{ margin:18px 0 4px; font-weight:600; opacity:.92; letter-spacing:.1px }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      font-family:'Open Sans',sans-serif;
      line-height:1.5;
      background:#181818; color:#dddddd;
      margin:0; padding:20px;
      display:flex; flex-direction:column; align-items:center;
      max-width:620px; margin-left:auto; margin-right:auto;
      user-select:none; cursor:default;
      transition: max-width .28s cubic-bezier(.2,.6,.2,1);
    }

    h1{ text-align:center; margin-top:.1em; font-size:var(--fs-h1); color:#fff; transition: font-size .28s ease }
    #meta-tz{ margin:-14px 0 12px; font-size:var(--fs-meta); color:#9a9a9a; text-align:center; transition: font-size .28s ease }

    h2{ font-size:var(--fs-h2); margin:25px 0 5px; position:relative; z-index:1; transition: font-size .28s ease }
    ul{ padding-left:0; margin:0 0 7px; display:flex; flex-direction:column; align-items:flex-start; position:relative; z-index:1 }

    .schedule-item{
      display:flex; align-items:flex-start;
      margin-bottom:5px; width:100%; padding-left:15px; border-radius:8px;
      transition: background-color .18s ease, padding .18s ease;
      cursor:pointer;
    }
    .schedule-item:hover{ background:var(--row-hover) }

    .time{
      display:flex; align-items:center; justify-content:center;
      margin-right:5px; padding:0 6px;
      width:var(--time-w-static); min-width:var(--time-w-static); max-width:var(--time-w-static);
      flex:0 0 var(--time-w-static);
      text-align:center; white-space:nowrap;
      border-radius:7px; color:var(--time-color);
      background:var(--time-bg); border:1px solid var(--time-border);
      font-size:var(--fs-time);
      font-variant-numeric:tabular-nums; font-feature-settings:'tnum' 1;
      transition: background .18s ease, color .18s ease, border-color .18s ease, width .28s cubic-bezier(.2,.6,.2,1), opacity .2s ease, font-size .28s ease;
    }
    .schedule-item:hover .time{ background:var(--time-bg-hover) }
    .time:empty{ visibility:hidden }
    .time.is-placeholder{ background:var(--ph-bg); border-color:var(--ph-border); color:var(--ph-color) }
    .format-anim .time{ opacity:.35 }

    .title{
      flex:1 1 auto;
      font-size:var(--fs-title); margin-left:5px; padding-right:15px; color:#ddd;
      text-decoration:none; cursor:inherit; transition: font-size .28s ease;
    }

    .empty-day{ color:#666; font-style:italic; margin-left:15px }

    /* кнопки */
    #button-container{ position:fixed; top:20px; right:20px; display:flex; gap:10px; z-index:50 }
    @media (max-width:1024px){ #button-container{ top:auto; bottom:20px } }
    .btn{
      background:rgba(51,51,51,.85); color:#fff; border:1px solid #666; border-radius:10px;
      display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer;
      padding:10px 14px; font-size:14px; letter-spacing:.2px;
      transition: background-color .18s ease, transform .06s ease, opacity .3s ease, border-color .18s ease;
    }
    .btn:hover{ background:rgba(68,68,68,.9); transform:translateY(-1px); border-color:#777 }
    .btn.hidden{ opacity:0; pointer-events:none }
    #scrollTodayButton{ text-transform:uppercase; letter-spacing:.6px }
    #gearButton{ width:40px; height:40px; padding:0; border-radius:10px }
    .icon-gear{ width:20px; height:20px; display:block }
    .icon-gear path, .icon-gear circle{ fill:none; stroke:currentColor; stroke-width:1.8; stroke-linecap:round; stroke-linejoin:round }

    /* контент + левый таймлайн */
    #schedule-wrap{ position:relative; width:100%; padding-left:calc(var(--gutter) + 12px); transition: padding-left .28s ease }

    #time-rail{ position:absolute; left:8px; top:0; width:var(--gutter); height:0; pointer-events:none; z-index:0 }
    #time-rail .rail-line{
      position:absolute; top:0; bottom:0; left:calc(var(--gutter)/2 - var(--rail-w)/2);
      width:var(--rail-w); border-radius:3px;
      background:linear-gradient(180deg, var(--rail-c1), var(--rail-c2));
      -webkit-mask-image:linear-gradient(to bottom, transparent 0%, #000 20px, #000 calc(100% - 20px), transparent 100%);
              mask-image:linear-gradient(to bottom, transparent 0%, #000 20px, #000 calc(100% - 20px), transparent 100%);
      box-shadow:inset 0 0 0 .5px rgba(0,0,0,.25);
      transition: height .24s ease, width .28s ease, left .28s ease;
    }

    /* маркер */
    #time-rail .now-tag{
      position:absolute; top:0; left:calc(50% - var(--rail-w)/2);
      width:0; height:0; opacity:0; transition:none;
    }
    .now-tag .dot{
      position:absolute; left:calc(var(--rail-w)/2 - 5px); top:-5px;
      width:10px; height:10px; border-radius:50%; background:#f8f8f8;
      box-shadow:0 0 0 2px rgba(255,255,255,.28), 0 0 12px rgba(255,255,255,.18);
      transition: left .28s ease;
    }
    .now-tag .ring{
      position:absolute; left:calc(var(--rail-w)/2 - 9px); top:-9px;
      width:18px; height:18px; border-radius:50%; border:1px solid rgba(255,255,255,.20);
      transition: left .28s ease;
    }
    .now-tag .connector{
      position:absolute; top:0; left:-6px; width:6px; height:1px;
      background:linear-gradient(to left, rgba(255,255,255,.24), rgba(255,255,255,0));
    }
    .now-tag .badge{
      position:absolute; left:calc(-8px - var(--tag-nudge)); top:calc(-1 * (var(--tag-h)/2) + .5px);
      transform:translateX(-100%);
      display:flex; align-items:center; justify-content:center;
      min-width:54px; max-width:160px; height:var(--tag-h);
      padding:0 var(--tag-pad-x); white-space:nowrap;
      font-size:var(--fs-badge); color:var(--tag-text);
      background:var(--tag-bg); border:1px solid var(--tag-br); border-radius:8px;
      box-shadow:var(--tag-shadow);
      backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px);
      transition: width .18s ease, left .18s ease, opacity .18s ease, height .28s ease, font-size .28s ease, padding .28s ease;
    }
    #time-rail .now-tag.ready{ opacity:1; transition: top .12s linear, opacity .18s ease; }

    @media (max-width:420px){
      :root{ --gutter:18px }
      #schedule-wrap{ padding-left:calc(var(--gutter) + 10px) }
      #time-rail{ left:6px }
      #time-rail .now-tag .badge{ max-width:140px }
    }

    /* настройки (модалка) */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center; z-index:100;
      opacity:0; transition: opacity .2s ease;
    }
    .modal-backdrop.show{ display:flex; }
    .modal-backdrop.show.visible{ opacity:1; }
    .modal{
      background:#1e1e1e; color:#e6e6e6; border:1px solid #333; border-radius:14px; padding:16px;
      width:min(560px, 92vw); box-shadow:0 12px 40px rgba(0,0,0,.55);
      transform: translateY(8px); opacity:.98; transition: transform .24s cubic-bezier(.2,.6,.2,1), opacity .24s ease;
    }
    .modal-backdrop.visible .modal{ transform:none; opacity:1; }
    .modal h3{ margin:0 0 12px; font-size:18px; font-weight:600 }
    .row{ display:flex; align-items:center; gap:12px; margin:12px 0; flex-wrap:wrap }
    .row label{ min-width:128px; font-size:14px; color:#bbb }

    .control{
      background:#2a2a2a; color:#fff; border:1px solid #3a3a3a; border-radius:10px;
      padding:10px 12px; font-size:14px; line-height:1; outline:none;
      transition: border-color .18s ease, box-shadow .18s ease, background-color .18s ease;
    }
    .control:focus{ border-color:#666; box-shadow:0 0 0 2px rgba(255,255,255,.06) }

    .select{
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      padding-right:34px; position:relative;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" stroke="%23cfcfcf" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 5l4 4 4-4"/></svg>');
      background-repeat:no-repeat; background-position:right 10px center; background-size:14px;
      cursor:pointer; transition: background-color .18s ease, border-color .18s ease;
    }

    /* мобильные правки для ровного выравнивания */
    @media (max-width:520px){
      .row{ align-items:stretch }
      .row label{ min-width:unset; flex: 1 1 100%; margin-bottom:6px }
      .row .control{ width:100% }
    }

    /* сегментный тумблер 24/12 */
    .seg-toggle{
      position:relative; display:grid; grid-template-columns:1fr 1fr;
      background:#2a2a2a; border:1px solid #3a3a3a; border-radius:10px; padding:4px; gap:4px;
      --seg-x:0%;
      transition: border-color .18s ease, background-color .18s ease;
    }
    .seg-toggle.mode12{ --seg-x:100%; }
    .seg-indicator{
      position:absolute; top:4px; left:4px; width:calc(50% - 4px); height:calc(100% - 8px);
      background:#3a3a3a; border-radius:8px; transition: transform .28s cubic-bezier(.2,.6,.2,1);
      transform: translateX(var(--seg-x));
      box-shadow:0 1px 0 rgba(255,255,255,.06), inset 0 0 0 .5px rgba(0,0,0,.25);
    }
    .segbtn{
      position:relative; z-index:1; background:transparent; border:0; border-radius:8px; color:#cfcfcf;
      padding:8px 10px; font-size:14px; cursor:pointer; transition: color .18s ease, transform .06s ease;
    }
    .segbtn:hover{ color:#fff; transform:translateY(-1px) }
    .segbtn.active{ color:#fff }

    .tz-collapsible{ overflow:hidden; max-height:0; opacity:0; transform:translateY(-4px);
      transition: max-height .28s cubic-bezier(.2,.6,.2,1), opacity .28s ease, transform .28s ease; }
    .tz-collapsible.open{ max-height:84px; opacity:1; transform:none; }

    .note{ font-size:12px; color:#9a9a9a }

    /* измеритель ширины таймкода */
    .time-measure{
      position:absolute; visibility:hidden; left:-9999px; top:-9999px;
      display:inline-block;
      padding:0 6px; border:1px solid transparent; border-radius:7px;
      white-space:nowrap; font-family:'Open Sans',sans-serif; font-size:var(--fs-time);
      font-variant-numeric:tabular-nums; font-feature-settings:'tnum' 1;
      min-width:0; max-width:none; flex:0 0 auto;
    }
  </style>
</head>
<body class="view-classic">
  <div id="button-container">
    <button id="scrollTodayButton" class="btn" aria-label="Прокрутить к сегодняшнему дню">На сегодня</button>
    <button id="gearButton" class="btn" aria-label="Настройки" title="Настройки">
      <svg class="icon-gear" viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.04 3.9l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
  </div>

  <h1 id="schedule-title">График выхода серий</h1>
  <div id="meta-tz"></div>

  <div id="schedule-wrap">
    <div id="time-rail" aria-hidden="true">
      <div class="rail-line"></div>
      <div class="now-tag">
        <span class="ring"></span>
        <span class="dot"></span>
        <span class="connector"></span>
        <span class="badge">00:00</span>
      </div>
    </div>
    <div id="schedule-container"></div>
  </div>

  <!-- Настройки -->
  <div id="settings" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div class="modal">
      <h3 id="settings-title">Настройки</h3>

      <div class="row">
        <label for="tzMode">Часовой пояс:</label>
        <select id="tzMode" class="control select">
          <option value="system">Авто (системный)</option>
          <option value="fixed">Пользовательский UTC±</option>
        </select>
      </div>

      <div id="tzFixedWrap" class="tz-collapsible">
        <div class="row" style="margin-top:0">
          <input id="tzOffsetText" class="control" inputmode="text" autocomplete="off" spellcheck="false" placeholder="+03:00" aria-label="Смещение, формат ±HH:MM" style="width:120px; text-align:center; font-variant-numeric:tabular-nums; letter-spacing:.04em">
          <span class="note">формат: ±HH:MM (шаг 15 мин)</span>
        </div>
      </div>

      <div class="row">
        <label>Формат времени:</label>
        <div id="clockSeg" class="seg-toggle" role="group" aria-label="Формат времени">
          <div class="seg-indicator" aria-hidden="true"></div>
          <button type="button" class="segbtn" data-mode="24">24ч</button>
          <button type="button" class="segbtn" data-mode="12">12ч AM/PM</button>
        </div>
      </div>

      <div class="row">
        <label for="viewMode">Вид:</label>
        <select id="viewMode" class="control select">
          <option value="classic">Классический</option>
          <option value="compact">Компактный</option>
          <option value="minimal">Минимализм</option>
        </select>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button id="closeSettings" class="btn">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      if(!window.luxon){ console.error('Luxon не загрузился'); return; }
      const { DateTime } = luxon;
      const $ = (sel, root=document) => root.querySelector(sel);

      /* ===== DATA ===== */
      const days = [
        { day: 'Понедельник', schedule: [
          { time: '15:00', title: 'Ван-Пис' },
          { time: '16:15', title: 'Увидимся завтра в ресторанном дворике' },
          { time: '18:15', title: 'Карманы лета' },
          { time: '19:45', title: 'Необъятный океан 2' },
        ]},
        { day: 'Вторник', schedule: [
          { time: '16:45', title: 'Девушка на час 4' },
          { time: '17:45', title: 'Сведённые кукушкой 2' },
          { time: '18:15', title: 'С нынешними детективами ничего не поделаешь' },
          { time: '18:30', title: 'Космическое шоу ужасов Некрономико' },
          { time: '21:45', title: 'Тёрки!' },
        ]},
        { day: 'Среда', schedule: [
          { time: '15:15', title: 'Клеватесс: Король демонических зверей, младенец и герой-нежить' },
          { time: '15:45', title: 'Герой щита 4' },
          { time: '17:45', title: 'Я переродился торговым автоматом и скитаюсь по лабиринту 2' },
          { time: '20:15', title: 'Три сестры Микадоно оказались неожиданно простыми' },
          { time: '20:40', title: 'Цикл оммёдзи: Перерождение' },
          { time: '21:15', title: 'Стать сильнее! Новая сага' },
        ]},
        { day: 'Четверг', schedule: [
          { time: '17:15', title: 'Доктор Стоун: Научное будущее. Часть 2' },
          { time: '17:45', title: 'Добро пожаловать в дешёвый ресторан изгнанника!' },
          { time: '19:15', title: 'Дандадан 2' },
          { time: '20:45', title: 'Строящийся город Камицубаки' },
          { time: '22:15', title: 'Маг воды' },
        ]},
        { day: 'Пятница', schedule: [
          { time: '18:15', title: 'Аркнайтс: Восстание из пепла' },
          { time: '18:45', title: 'Тёмный демон' },
          { time: '19:45', title: 'Молчаливая ведьма: Тайна молчаливой колдуньи' },
          { time: '20:45', title: 'За небрежной молодой девушкой ухаживает бывший жених её сестры' },
        ]},
        { day: 'Суббота', schedule: [
          { time: '11:00', title: 'Повелитель тайн: Клоун' },
          { time: '16:30', title: 'Энн Ширли' },
          { time: '17:45', title: 'Кайдзю номер восемь 2' },
          { time: '18:15', title: 'Герой, упавший в обморок, и принцессы-убийцы' },
          { time: '18:45', title: 'Белого мага, изгнанного из команды героя, подобрал авантюрист ранга S: Этот белый маг слишком нестандартный' },
          { time: '19:15', title: 'Этот глупый свин не понимает мечту Санта-Клауса' },
          { time: '19:45', title: 'Эта фарфоровая кукла влюбилась 2' },
          { time: '21:15', title: 'Дождь и ты' },
        ]},
        { day: 'Воскресенье', schedule: [
          { time: '04:00', title: 'Быть героем Икс' },
          { time: '11:45', title: 'Ведьмнадзор' },
          { time: '12:15', title: 'Туалетный мальчик Ханако 2. Часть 2' },
          { time: '16:45', title: 'Драгоценности Рури' },
          { time: '17:00', title: 'Апокалипсис Миногры: Покорение другого мира начинается с разрушенной цивилизации' },
          { time: '17:30', title: 'Ночь живых кошаков' },
          { time: '18:00', title: 'Межкультурный обмен с девушкой у игровых автоматов' },
          { time: '19:45', title: 'Отель для нелюдей' },
        ]},
        { day: 'Без графика', schedule: [
          { title: 'Город (понедельник)' },
          { title: 'Хроники людей и демонов (вторник)' },
          { title: 'У меня нет любовницы! А может и есть?! (вторник)' },
          { title: 'Дни Сакамото. Часть 2 (понедельник)' },
          { title: 'Песнь ночных сов 2 (пятница)' },
          { title: 'Благоухающий цветок расцветает с достоинством (суббота)' },
          { title: 'Букет для гадкой девочки (суббота)' },
          { title: 'Девять: Корона правителя (воскресенье)' },
          { title: 'Плохая девочка (воскресенье)' },
          { title: 'Лето, когда погас свет (воскресенье)' },
          { title: 'Пуля/Пуля' },
          { title: 'Нукитаси' },
          { title: 'Сверхкуб' },
          { title: 'Адский учитель Нубэ (2025)' },
          { title: 'Мобильный воин Гандам: GQuuuuuuX' },
          { title: 'Рок — женская скромность' },
          { title: 'Старик из деревни становится Святым мечом' },
          { title: 'Боевой отряд «Полный провал» 2' },
          { title: 'Долги...' },
        ]}
      ];

      /* ===== STATE / SETTINGS ===== */
      const computeDefaultView = () =>
        (window.matchMedia && window.matchMedia('(max-width: 560px)').matches) ? 'compact' : 'classic';

      const settings = {
        tzMode: localStorage.getItem('tzMode') || 'system',
        tzOffsetMin: parseInt(localStorage.getItem('tzOffsetMin') || '180', 10),
        clock12: localStorage.getItem('clock12') === 'true',
        viewMode: localStorage.getItem('viewMode') || computeDefaultView()
      };

      function zoneId(){
        if(settings.tzMode === 'system'){
          return Intl.DateTimeFormat().resolvedOptions().timeZone;
        }else{
          const m = settings.tzOffsetMin;
          const sign = m>=0 ? '+' : '-';
          const abs = Math.abs(m);
          const hh = String(Math.floor(abs/60)).padStart(2,'0');
          const mm = String(abs%60).padStart(2,'0');
          return `UTC${sign}${hh}:${mm}`;
        }
      }
      function offsetLabel(mins){
        const sign = mins>=0 ? '+' : '-';
        const abs = Math.abs(mins);
        const hh = String(Math.floor(abs/60)).padStart(2,'0');
        const mm = String(abs%60).padStart(2,'0');
        return `UTC${sign}${hh}:${mm}`;
      }
      function fmt(dt){
        if(settings.clock12){
          return dt.toFormat('hh:mm a').replace(' AM','\u202FAM').replace(' PM','\u202FPM');
        }
        return dt.toFormat('HH:mm');
      }

      function updateMeta(){
        const z = zoneId();
        const off = DateTime.local().setZone(z).offset;
        const label = (settings.tzMode === 'system') ? `${z} (${offsetLabel(off)})` : `${offsetLabel(settings.tzOffsetMin)}`;
        document.getElementById('meta-tz').textContent = `Время сейчас: ${label}. База расписания: Europe/Moscow.`;
      }

      /* конвертация */
      function convertReferenceTimeToLocal(){
        const referenceZone='Europe/Moscow';
        const localZone = zoneId();
        const MON=1;
        const refNow=DateTime.local().setZone(referenceZone);
        const baseMondayRef=refNow.minus({ days: refNow.weekday - MON }).startOf('day');
        const newDays=days.map(d=>({ day:d.day, schedule:[] }));

        days.forEach((day, index)=>{
          day.schedule.forEach(show=>{
            if(show.time){
              const [hh,mm]=show.time.split(':').map(Number);
              const refDT = baseMondayRef.plus({ days:index }).set({ hour:hh, minute:mm });
              const locDT = refDT.setZone(localZone);
              const newDayIndex = (locDT.weekday + 6) % 7;
              newDays[newDayIndex].schedule.push({
                ...show,
                time: fmt(locDT),
                mins: locDT.hour*60 + locDT.minute
              });
            }else{
              newDays[index].schedule.push({ ...show, mins: Infinity });
            }
          });
        });
        newDays.forEach(day=> day.schedule.sort((a,b)=> (a.mins||Infinity) - (b.mins||Infinity)));
        return newDays;
      }

      const NO_TIME = '—';
      const WD_ABBR = {
        'понедельник':'Пн','вторник':'Вт','среда':'Ср','четверг':'Чт','пятница':'Пт','суббота':'Сб','воскресенье':'Вс',
        'пн':'Пн','вт':'Вт','ср':'Ср','чт':'Чт','пт':'Пт','сб':'Сб','вс':'Вс'
      };
      function parseNoScheduleTitle(title){
        const m = title.match(/\(([^)]+)\)\s*$/i);
        if(!m) return { title, abbr: NO_TIME };
        const raw = m[1].trim().toLowerCase();
        const key = raw.replace(/\./g,'');
        const abbr = WD_ABBR[key] || NO_TIME;
        return { title: title.replace(/\s*\([^)]+\)\s*$/,'').trim(), abbr };
      }

      function scheduleItem(info, placeholder=false, placeholderLabel=NO_TIME){
        const el = document.createElement('div');
        el.className = 'schedule-item';
        el.setAttribute('role','button'); el.tabIndex = 0;

        const t = document.createElement('span');
        t.className = 'time';
        if(placeholder) t.classList.add('is-placeholder');

        const hasTime = typeof info.time === 'string' && info.time.trim() !== '';
        t.textContent = hasTime ? info.time : placeholder ? (placeholderLabel || NO_TIME) : NO_TIME;
        if(!hasTime){ t.setAttribute('aria-label', placeholder ? 'без времени, день выпуска' : 'без времени'); }

        const title = document.createElement('span');
        title.className = 'title';
        title.textContent = info.title || '';

        const openLink = ()=>{
          if(!info.title) return;
          window.open('https://shikimori.one/animes?search=' + encodeURIComponent(info.title), '_blank');
        };
        el.addEventListener('click', openLink);
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openLink(); } });

        el.appendChild(t);
        el.appendChild(title);
        return el;
      }

      function render(converted){
        const c = document.getElementById('schedule-container');
        c.innerHTML = '';

        for(let di=0; di<7; di++){
          const day = converted[di];
          const block = document.createElement('div');
          block.className = 'day-block'; block.dataset.di = di;

          const h2 = document.createElement('h2');
          h2.textContent = `${day.day}:`;
          block.appendChild(h2);

          const ul = document.createElement('ul');
          if(day.schedule.length){
            day.schedule.forEach(show => ul.appendChild(scheduleItem(show, false)));
          } else {
            const empty = document.createElement('div');
            empty.className='empty-day';
            empty.textContent='Пусто';
            ul.appendChild(empty);
          }
          block.appendChild(ul);
          c.appendChild(block);
        }

        // Без графика
        const block = document.createElement('div');
        block.className = 'day-block';
        const h2 = document.createElement('h2');
        h2.textContent = 'Без графика:';
        block.appendChild(h2);
        const ul = document.createElement('ul');
        days[7].schedule.forEach(x => {
          const parsed = parseNoScheduleTitle(x.title);
          ul.appendChild(scheduleItem({ title: parsed.title }, true, parsed.abbr));
        });
        block.appendChild(ul);
        c.appendChild(block);
      }

      /* таймлайн метрики */
      const metrics = { railTop:0, railH:0, todayTopRel:0, todayH:0 };

      function layoutRail(){
        const wrap = document.getElementById('schedule-wrap');
        const rail = document.getElementById('time-rail');
        const blocks = [...document.querySelectorAll('#schedule-container > .day-block')].filter(b => b.dataset.di !== undefined);
        if(blocks.length < 7) return;

        const wrapTop = wrap.getBoundingClientRect().top + window.pageYOffset;
        const first = blocks[0].getBoundingClientRect();
        const last  = blocks[6].getBoundingClientRect();

        const railTop = (first.top + window.pageYOffset) - wrapTop;
        const railBottom = (last.bottom + window.pageYOffset) - wrapTop;

        metrics.railTop = railTop;
        metrics.railH   = Math.max(0, railBottom - railTop);

        rail.style.top = `${railTop}px`;
        rail.style.height = `${metrics.railH}px`;

        const now = DateTime.local().setZone(zoneId());
        const todayIdx = (now.weekday + 6) % 7;
        const todayBlock = document.querySelector(`.day-block[data-di="${todayIdx}"]`);
        if(!todayBlock) return;

        const todayRect = todayBlock.getBoundingClientRect();
        const todayTop = (todayRect.top + window.pageYOffset) - wrapTop;
        const todayBottom = (todayRect.bottom + window.pageYOffset) - wrapTop;

        metrics.todayTopRel = todayTop - railTop;
        metrics.todayH = Math.max(1, todayBottom - todayTop);
      }

      function setNow(y){
        const tag = document.querySelector('#time-rail .now-tag');
        const top = Math.max(0, Math.min(metrics.railH, y));
        tag.style.top = `${top}px`;
      }

      let lastMinute = -1;
      function updateNowLabel(force=false){
        const now = DateTime.local().setZone(zoneId());
        if(force || now.minute !== lastMinute){
          lastMinute = now.minute;
          document.querySelector('#time-rail .badge').textContent = fmt(now);
        }
      }

      function clampTagIntoView(){
        const badge = document.querySelector('#time-rail .now-tag .badge');
        if(!badge) return;
        badge.style.setProperty('--tag-nudge','0px');
        const rect = badge.getBoundingClientRect();
        const minLeft = 6;
        if(rect.left < minLeft){
          const delta = Math.ceil(minLeft - rect.left);
          badge.style.setProperty('--tag-nudge', delta + 'px');
        }
      }

      function animate(){
        const now = DateTime.local().setZone(zoneId());
        const totalMin = now.hour*60 + now.minute + now.second/60 + now.millisecond/60000;
        const ratio = Math.max(0, Math.min(1, totalMin/1440));
        const y = metrics.todayTopRel + metrics.todayH * ratio;
        setNow(y);
        updateNowLabel();
        requestAnimationFrame(animate);
      }

      /* ширина таймкода — без накопления */
      function recalcTimeWidth(){
        const sample = settings.clock12 ? '12:00\u202FPM' : '00:00';
        const probe = document.createElement('span');
        probe.className = 'time-measure';
        probe.textContent = sample;
        document.body.appendChild(probe);
        const w = probe.offsetWidth;
        const finalW = Math.max(60, w + 2);
        document.documentElement.style.setProperty('--time-w-static', finalW + 'px');
        probe.remove();
      }

      function smoothFormatSwitch(){
        document.body.classList.add('format-anim');
        recalcTimeWidth();
        const converted = convertReferenceTimeToLocal();
        for(let di=0; di<7; di++){
          const block = document.querySelector(`.day-block[data-di="${di}"]`);
          if(!block) continue;
          const times = block.querySelectorAll('.schedule-item .time');
          const list = converted[di].schedule;
          times.forEach((node, idx)=>{
            const show = list[idx];
            if(!show) return;
            node.textContent = show.time || NO_TIME;
          });
        }
        updateNowLabel(true);
        setTimeout(()=> document.body.classList.remove('format-anim'), 320);
        requestAnimationFrame(()=>{ layoutRail(); clampTagIntoView(); });
      }

      const settingsModal = document.getElementById('settings');
      const tzModeSel = document.getElementById('tzMode');
      const tzFixedWrap = document.getElementById('tzFixedWrap');
      const tzOffsetText = document.getElementById('tzOffsetText');
      const seg = document.getElementById('clockSeg');
      const segBtns = seg.querySelectorAll('.segbtn');
      const viewSel = document.getElementById('viewMode');

      const setSegActive = (mode)=>{
        segBtns.forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
        seg.classList.toggle('mode12', mode==='12');
      };

      function parseOffsetText(s){
        if(!s) return null;
        s = s.trim();
        const m = s.match(/^([+-])?\s*(\d{1,2})(?::?(\d{2}))?$/);
        if(!m) return null;
        const sign = (m[1] === '-') ? -1 : 1;
        const hh = parseInt(m[2],10);
        const mm = parseInt(m[3]||'0',10);
        if(hh>14 || mm>59) return null;
        const mmRound = Math.round(mm/15)*15;
        const total = sign * (hh*60 + mmRound);
        if(total > 14*60 || total < -12*60) return null;
        return total;
      }
      const formatOffset = mins => {
        const sign = mins>=0 ? '+' : '-';
        const abs = Math.abs(mins);
        const hh = String(Math.floor(abs/60)).padStart(2,'0');
        const mm = String(abs%60).padStart(2,'0');
        return `${sign}${hh}:${mm}`;
      };

      function applyViewMode(){
        document.body.classList.toggle('view-classic', settings.viewMode==='classic');
        document.body.classList.toggle('view-compact', settings.viewMode==='compact');
        document.body.classList.toggle('view-minimal', settings.viewMode==='minimal');
        recalcTimeWidth();
        layoutRail();
        clampTagIntoView();
      }

      function openSettings(){
        tzModeSel.value = settings.tzMode;
        tzFixedWrap.classList.toggle('open', settings.tzMode === 'fixed');
        tzOffsetText.value = formatOffset(settings.tzOffsetMin);
        tzOffsetText.classList.remove('ok','err');

        setSegActive(settings.clock12 ? '12' : '24');
        viewSel.value = settings.viewMode;

        settingsModal.classList.add('show');
        requestAnimationFrame(()=> settingsModal.classList.add('visible'));
      }
      function closeSettings(){
        settingsModal.classList.remove('visible');
        setTimeout(()=> settingsModal.classList.remove('show'), 240);
      }

      function persistAndRerender(){
        localStorage.setItem('tzMode', settings.tzMode);
        localStorage.setItem('tzOffsetMin', String(settings.tzOffsetMin));
        localStorage.setItem('clock12', settings.clock12 ? 'true' : 'false');
        localStorage.setItem('viewMode', settings.viewMode);

        updateMeta();
        render(convertReferenceTimeToLocal());
        applyViewMode();
        updateNowLabel(true);
      }

      tzModeSel.addEventListener('change', ()=>{
        settings.tzMode = tzModeSel.value;
        tzFixedWrap.classList.toggle('open', settings.tzMode === 'fixed');
        persistAndRerender();
      });

      let tzDebounce;
      tzOffsetText && tzOffsetText.addEventListener('input', ()=>{
        clearTimeout(tzDebounce);
        tzDebounce = setTimeout(()=>{
          const parsed = parseOffsetText(tzOffsetText.value);
          if(parsed === null){
            tzOffsetText.classList.remove('ok'); tzOffsetText.classList.add('err');
          }else{
            tzOffsetText.classList.remove('err'); tzOffsetText.classList.add('ok');
            settings.tzOffsetMin = parsed;
            tzOffsetText.value = formatOffset(parsed);
            persistAndRerender();
          }
        }, 160);
      });

      seg.addEventListener('click', (e)=>{
        const btn = e.target.closest('.segbtn');
        if(!btn) return;
        const want12 = (btn.dataset.mode === '12');
        if(settings.clock12 === want12) return;
        settings.clock12 = want12;
        setSegActive(settings.clock12 ? '12' : '24');
        localStorage.setItem('clock12', settings.clock12 ? 'true' : 'false');
        smoothFormatSwitch();
      });

      viewSel.addEventListener('change', ()=>{
        settings.viewMode = viewSel.value;
        applyViewMode();
        setTimeout(persistAndRerender, 60);
      });

      document.getElementById('gearButton').addEventListener('click', openSettings);
      document.getElementById('closeSettings').addEventListener('click', closeSettings);
      document.getElementById('settings').addEventListener('click', (e)=>{ if(e.target === document.getElementById('settings')) closeSettings(); });

      function scrollToToday(){
        const now = DateTime.local().setZone(zoneId());
        const di = (now.weekday + 6) % 7;
        const block = document.querySelector(`.day-block[data-di="${di}"]`);
        if(block){
          const y = block.getBoundingClientRect().top + window.pageYOffset - 14;
          window.scrollTo({ top:y, behavior:'smooth' });
        }
      }
      document.getElementById('scrollTodayButton').addEventListener('click', scrollToToday);

      window.addEventListener('scroll', ()=>{
        const hidden = window.pageYOffset > 40;
        document.getElementById('scrollTodayButton').classList.toggle('hidden', hidden);
        document.getElementById('gearButton').classList.toggle('hidden', hidden);
      }, { passive:true });

      let ro;
      if('ResizeObserver' in window){
        ro = new ResizeObserver(()=> requestAnimationFrame(()=>{ layoutRail(); clampTagIntoView(); }));
      }
      window.addEventListener('resize', ()=>{
        // если пользователь ещё не выбирал вид — пересчитать дефолт для телефонов при повороте
        if(!localStorage.getItem('viewMode')){
          const auto = computeDefaultView();
          if(auto !== settings.viewMode){
            settings.viewMode = auto;
            applyViewMode();
            localStorage.setItem('viewMode', auto);
          }
        }
        layoutRail(); recalcTimeWidth(); clampTagIntoView();
      }, { passive:true });

      /* INIT */
      document.addEventListener('DOMContentLoaded', ()=>{
        // применить дефолтный/сохранённый вид до рендеров
        applyViewMode();

        recalcTimeWidth();
        updateMeta();
        render(convertReferenceTimeToLocal());
        layoutRail();

        if(ro){ ro.observe(document.getElementById('schedule-container')); }

        if(document.fonts && document.fonts.ready){
          document.fonts.ready.then(()=>{ recalcTimeWidth(); layoutRail(); clampTagIntoView(); });
        }

        // первичная позиция маркера
        const now = DateTime.local().setZone(zoneId());
        const minutes = now.hour*60 + now.minute + now.second/60 + now.millisecond/60000;
        const ratio = Math.max(0, Math.min(1, minutes/1440));
        const y = metrics.todayTopRel + metrics.todayH * ratio;
        setNow(y);
        updateNowLabel(true);
        clampTagIntoView();
        requestAnimationFrame(()=> document.querySelector('#time-rail .now-tag').classList.add('ready'));

        // анимация маркера
        requestAnimationFrame(animate);

        // минутная ресинхронизация
        const sync=()=>{
          const n=new Date();
          const ms=60000 - (n.getSeconds()*1000 + n.getMilliseconds());
          setTimeout(()=>{ updateMeta(); render(convertReferenceTimeToLocal()); layoutRail(); clampTagIntoView(); sync(); }, Math.max(400, ms));
        };
        sync();
      });
    })();
  </script>
</body>
</html>
